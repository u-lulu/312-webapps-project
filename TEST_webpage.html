<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSE 312 Project</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
</head>
<body>
    <h1>Hello, {{Guest}}</h1>
    <p>Here's a little paragraph. Yay! And also a link to somewhere else: <a href="https://www.youtube.com/watch?v=NY4u1JeG-2Y" target="_blank" rel="noreferrer noopener">good song</a></p>
    <img src="images/TEST_SniperDecoy.png">
    <p class="jstest">If you can see this text, loading JavaScript isn't working.</p>
    <script src="scripts/TEST_paragraph_filler.js"></script>

    <!-- Registration Forms -->
    <h2>Register</h2>
    <form action="/register" method="post" enctype="application/x-www-form-urlencoded">
        <label>Username:
            <input id="reg-form-username" type="text" name="username_reg"/>
        </label>
        <br/>
        <label>Password:&nbsp;
            <input id="reg-form-pass" type="password" name="password_reg">
        </label>
        <br/>
        <label>Enter password again:&nbsp;
            <input id="reg-form-pass2" type="password" name="password_reg2">
        </label>
        <input type="submit" value="Post">
    </form>

    <!-- Login Forms -->
    <h2>Login</h2>
    <form action="/login" method="post" enctype="application/x-www-form-urlencoded">
        <label>Username:
            <input id="login-form-username" type="text" name="username_login"/>
        </label>
        <br/>
        <label>Password:&nbsp;
            <input id="login-form-pass" type="password" name="password_login">
        </label>
        <input type="submit" value="Post">
    </form>

    <!-- Logout Button -->
    <form action="/logout" method ="post" name="logout-User" enctype="application/x-www-form-urlencoded">
        <input type="submit" value="Logout">
    </form>


    <!-- Message Forms -->
    <h2>Text Entry</h2>
    <form id="message_form">
        <label for="body_text">Enter Text:</label><br>
        <input type="text" id="body_text" name="body_text"/><br>
        <button type="submit">Send</button>
    </form>
    <h2>Dice Entry</h2>
    <form id="dice_form">
        <label for="body_text">Enter some <a href="https://github.com/fionafibration/py-rolldice#dice-syntax" target="_blank" rel="noreferrer noopener">Dice Syntax</a>:</label><br>
        <input type="text" id="dice_text" name="dice_text"/><br>
        <button type="submit">Send</button>
    </form>

    <!-- Message List -->
    <h2>Messages</h2>
    <ul id="messages"></ul>

    <script>
        // Make a request to the /posts route
        fetch('/posts')
            .then(response => response.json())
            .then(data => {
                // Function to add a new message to the list
                function addMessage(message) {
                    const listItem = document.createElement('li');
                    listItem.textContent = message;
                    document.getElementById('messages').appendChild(listItem);
                }

                // Loop through each message in the list
                data.forEach(message => {
                    // Check the type of the message
                    if (message.type === 'text') {
                        // Extract username and body
                        const formattedMessage = `${message.username}: ${message.body}`;
                        addMessage(formattedMessage);
                    } else if (message.type === 'dice') {
                        // Extract username, input, output, and total
                        const formattedMessage = `${message.username} rolled ${message.input} and got ${message.total} (${message.output})`;
                        addMessage(formattedMessage);
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching messages:', error);
            });
    </script>

    <!-- Websocket Handler -->
    <script type="text/javascript" charset="utf-8">
        var socket = io();
        socket.on('connect', function() {
            socket.emit('my event', {data: 'I\'m connected!'});
        });

        // Handle form submission
        $('#message_form').submit(function(event) {
            event.preventDefault(); // Prevent default form submission behavior

            // Get the message from the input field
            var message = $('#body_text').val().trim();

            // Check if the message is not empty
            if (message !== '') {
                // Send the message to the server via WebSocket
                socket.emit('chat_message', message);

                // Clear the input field
                $('#body_text').val('');
            }
        });

        // Handle dice submission
        $('#dice_form').submit(function(event) {
            event.preventDefault(); // Prevent default form submission behavior

            // Get the message from the input field
            var message = $('#dice_text').val().trim();

            // Check if the message is not empty
            if (message !== '') {
                // Send the message to the server via WebSocket
                socket.emit('dice_message', message);

                // Clear the input field
                $('#dice_text').val('');
            }
        });

        // Function to add a new message to the list
        function addMessage(message) {
            $('#messages').append($('<li>').text(message));
        }

        // Receive messages from server
        socket.on('message', function(message) {
            if (message.type === 'text') {
                // Extract username and body
                const formattedMessage = `${message.username}: ${message.body}`;
                addMessage(formattedMessage);
            } else if (message.type === 'dice') {
                // Extract username, input, output, and total
                const formattedMessage = `${message.username} rolled ${message.input} and got ${message.total} (${message.output})`;
                addMessage(formattedMessage);
            }
        });
    </script>

</body>
</html>